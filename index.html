<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–í—Ö—ñ–¥ ‚Ä¢ –°—Ç–∞—Ç–∏ –Ω–∞ –æ–±–ª—ñ–∫</title>
<style>
  body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  margin: 0;
  background: url("vlk.1-1-1.jpg") no-repeat center center fixed; /* üëà —à–ª—è—Ö –¥–æ –∫–∞—Ä—Ç–∏–Ω–∫–∏ */
  background-size: cover; /* –∑–∞–ø–æ–≤–Ω—é—î –µ–∫—Ä–∞–Ω */
  color: #e2e8f0;
  overflow-x: hidden;
}

  .wrap{max-width:900px;margin:40px auto;padding:0 16px}
  .card {
  background: rgba(17, 24, 39, 0.8); /* –Ω–∞–ø—ñ–≤–ø—Ä–æ–∑–æ—Ä–∏–π —Ç–µ–º–Ω–∏–π —Ñ–æ–Ω */
  backdrop-filter: blur(8px);        /* –µ—Ñ–µ–∫—Ç —Å–∫–ª–∞ ‚Äî —Ä–æ–∑–º–∏—Ç—Ç—è —Ñ–æ–Ω—É –ø—ñ–¥ –±–ª–æ–∫–æ–º */
  border: 1px solid rgba(255, 255, 255, 0.1); /* —Å–≤—ñ—Ç–ª–∞ —Ä–∞–º–∫–∞ –∑ –ª–µ–≥–∫–∏–º –ø—Ä–æ–∑–æ—Ä–∏–º –µ—Ñ–µ–∫—Ç–æ–º */
  border-radius: 14px;
  padding: 20px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3); /* —Ç—ñ–Ω—å –¥–ª—è –≥–ª–∏–±–∏–Ω–∏ */
  margin-bottom: 16px;
}
  h1{margin:0 0 10px}
  .muted{color:#94a3b8}
  .row{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0;align-items:center}
  input{padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e2e8f0;min-width:260px}
  button{padding:10px 14px;border-radius:10px;border:1px solid #334155;background:#1f2937;color:#e2e8f0;cursor:pointer}
  button:hover{background:#243041}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border-bottom:1px solid #243041;padding:10px 8px;text-align:left}
  th{color:#9fb2d1;font-weight:600}
  #preTestOverlay{position:fixed;inset:0;background:rgba(15,23,42,.96);display:none;justify-content:center;align-items:center;flex-direction:column;z-index:9999;text-align:center}
  #preTestOverlay.show{display:flex;animation:fadeIn .3s ease forwards}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  #preTestOverlay h2{font-size:2rem;margin-bottom:10px}
  #preTestOverlay p{color:#9fb2d1;font-size:1.1rem;margin-bottom:20px}
</style>
</head>
<body>
<div class="wrap">
  <!-- –°—Ç–∞—Ç–∏ –Ω–∞ –æ–±–ª—ñ–∫ -->
  <div class="card">
    <h1>–°—Ç–∞—Ç–∏ –Ω–∞ –æ–±–ª—ñ–∫</h1>
    <p class="muted" id="hello">–í–∫–∞–∂–∏ —ñ–º‚Äô—è, —â–æ–± —Å—Ç–∞—Ç–∏ –Ω–∞ –æ–±–ª—ñ–∫.</p>

    <div id="regBox" class="row">
      <input id="nameInput" type="text" maxlength="40" placeholder="–¢–≤–æ—î —ñ–º‚Äô—è">
      <button onclick="register()">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
    </div>

    <!-- –î—ñ—ó –ø—ñ—Å–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó (—Å—é–¥–∏ –º–∞–ª—é—î–º–æ ¬´–ü—Ä–æ–π—Ç–∏ –í–õ–ö¬ª –¥–ª—è —Å—Ç–∞—Ç—É—Å—É 2 –∞–±–æ —Ö–∞–±–∞—Ä –¥–ª—è —Å—Ç–∞—Ç—É—Å—É 3) -->
    <div id="actions" class="row"></div>

    <p class="muted" id="regHint"></p>
  </div>

  <!-- –û—Å–æ–±–æ–≤–∏–π —Å–∫–ª–∞–¥ -->
  <div class="card" style="margin-top:16px">
    <h1>–û—Å–æ–±–æ–≤–∏–π —Å–∫–ª–∞–¥</h1>
    <table>
      <thead><tr><th>–Ü–º‚Äô—è</th><th>–°—Ç–∞—Ç—É—Å</th><th>–•–∞–±–∞—Ä—ñ ($)</th></tr></thead>
      <tbody id="boardBody"><tr><td colspan="3" class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</td></tr></tbody>
    </table>
  </div>
</div>

<!-- –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–æ–º -->
<div id="preTestOverlay">
  <h2>üß† –£–≤–∞–≥–∞!</h2>
  <p>–£ —Ç–µ–±–µ —î –ª–∏—à–µ <strong>3 —Å–ø—Ä–æ–±–∏</strong> –ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç.</p>
  <p id="countdownText">–ü–µ—Ä–µ—Ö—ñ–¥ —á–µ—Ä–µ–∑ <span id="count">3</span> —Å‚Ä¶</p>
</div>

<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyABgG9BNjzZP0LgMMOmirxUF_dccywAECI",
    authDomain: "test1-b220e.firebaseapp.com",
    projectId: "test1-b220e",
    storageBucket: "test1-b220e.firebasestorage.app",
    messagingSenderId: "913590893459",
    appId: "1:913590893459:web:04f04c5935eb24a3de0666",
    measurementId: "G-8PJR7M8F8Y"
  };

  const STATUS = {PASSED:1, DRAFT:2, FAILED:3};
  const $ = id => document.getElementById(id);

  let useFb = !!firebaseConfig.apiKey;
  let app,auth,db,fs;

  let playerId = localStorage.getItem('playerId') || crypto.randomUUID();
  localStorage.setItem('playerId', playerId);
  let playerName = localStorage.getItem('playerName') || "";

  async function boot(){
    if(useFb){
      const appSdk = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js');
      const authSdk = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js');
      const fsSdk   = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js');
      app = appSdk.initializeApp(firebaseConfig);
      auth = authSdk.getAuth(app);
      fs   = fsSdk;
      try{ await authSdk.signInAnonymously(auth); }catch(e){ useFb=false; }
      db = fsSdk.initializeFirestore(app,{experimentalForceLongPolling:true,useFetchStreams:false,ignoreUndefinedProperties:true});
    }

    if(playerName && useFb){
      const ref  = fs.doc(db,'players',playerId);
      const snap = await fs.getDoc(ref);

      if(!snap.exists()){
        localStorage.clear();
        playerId = crypto.randomUUID();
        localStorage.setItem('playerId', playerId);
        $('regBox').style.display = 'flex';
      } else {
        $('hello').textContent = '–í–∏ –≤–∂–µ —Å—Ç–æ—ó—Ç–µ –Ω–∞ –æ–±–ª—ñ–∫—É';
        $('regBox').style.display = 'none';
        await syncStatusFromDb();
        renderActions();              // ‚Üê –º–∞–ª—é—î–º–æ –ø–æ—Ç—Ä—ñ–±–Ω—É –∫–Ω–æ–ø–∫—É –ø—ñ–¥ —Å—Ç–∞—Ç—É—Å
      }
    }
    await loadBoard();
  }

  // –ø–æ–∫–∞–∑–∞—Ç–∏ —Ç–µ–∫—Å—Ç-–ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è —ñ –ø–µ—Ä–µ–π—Ç–∏ –¥–æ —Ç–µ—Å—Ç—É
  function showPreTestOverlay(){
    const overlay = $('preTestOverlay');
    overlay.classList.add('show');
    let sec = 3;
    const c = $('count');
    const t = setInterval(()=>{
      sec--; c.textContent = sec;
      if(sec<=0){ clearInterval(t); location.href='play.html'; }
    },1000);
  }

  // –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è ¬´–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏¬ª
  async function register(){
    const name = $('nameInput').value.trim().slice(0,40);
    if(!name){ $('regHint').textContent='–í–≤–µ–¥–∏ —ñ–º‚Äô—è'; return; }

    playerName = name;
    localStorage.setItem('playerName', name);
    $('hello').textContent = '–í–∏ –≤–∂–µ —Å—Ç–æ—ó—Ç–µ –Ω–∞ –æ–±–ª—ñ–∫—É';
    $('regBox').style.display = 'none';

    await ensurePlayerRecord(name);
    await syncStatusFromDb();
    await loadBoard();
    renderActions();                 // –Ω–∞ –≤–∏–ø–∞–¥–æ–∫, —è–∫—â–æ —Å—Ç–∞—Ç—É—Å —É–∂–µ 2/3

    showPreTestOverlay();
  }

  async function syncStatusFromDb(){
    if(!useFb) return;
    try{
      const ref = fs.doc(db,'players',playerId);
      const snap = await fs.getDoc(ref);
      if(snap.exists()){
        const s = Number(snap.data().status);
        if(s===1||s===3) localStorage.setItem('status',String(s));
      }
    }catch(e){}
  }

  // –ù–∞–º–∞–ª—é–≤–∞—Ç–∏ –¥—ñ—ó –ø—ñ–¥ —Å—Ç–∞—Ç—É—Å: –í–õ–ö –¥–ª—è —É—Ö–∏–ª—è–Ω—Ç–∞ –∞–±–æ —Ö–∞–±–∞—Ä –¥–ª—è –º–æ–±—ñ–ª—ñ–∑–æ–≤–∞–Ω–æ–≥–æ
  function renderActions(){
    const actions = $('actions');
    if(!actions) return;
    actions.innerHTML = '';
    const status = Number(localStorage.getItem('status')) || 2;

    if(status === STATUS.DRAFT){ // 2 ‚Äî –£—Ö–∏–ª—è–Ω—Ç
      const btn = document.createElement('button');
      btn.textContent = '–ü—Ä–æ–π—Ç–∏ –í–õ–ö ‚Üí';
      btn.onclick = () => location.href='play.html';
      actions.appendChild(btn);
    }

    if(status === STATUS.FAILED){ // 3 ‚Äî –ú–æ–±—ñ–ª—ñ–∑–æ–≤–∞–Ω–∏–π
      const btn = document.createElement('button');
      btn.textContent = 'üí∏ 100$ –ø–æ–∂–µ—Ä—Ç–≤–∞ –¥–ª—è –¢–¶–ö ‚Äî ¬´–ü–æ—á–∞—Ç–∏ –∑–∞–Ω–æ–≤–æ¬ª';
      btn.onclick = retryWithBribe;
      actions.appendChild(btn);
    }
  }

  // –î–∞—Ç–∏ —Ö–∞–±–∞—Ä + —Å–∫–∏–Ω—É—Ç–∏ —Å—Ç–∞—Ç—É—Å –Ω–∞ DRAFT(2) + –ø–µ—Ä–µ—Ö—ñ–¥ –¥–æ —Ç–µ—Å—Ç—É
  async function retryWithBribe(){
    const cur = Number(localStorage.getItem('bribes'))||0;
    const next = cur + 100;
    localStorage.setItem('bribes', String(next));
    localStorage.setItem('status', String(STATUS.DRAFT));

    if(useFb){
      const ref = fs.doc(db,'players',playerId);
      await fs.setDoc(ref,{
        bribes: next,
        status: STATUS.DRAFT,
        updatedAt: Date.now(),
        name: playerName
      },{merge:true});
    }
    location.href = 'play.html';
  }

  // —Å—Ç–≤–æ—Ä—é—î–º–æ/–æ–Ω–æ–≤–ª—é—î–º–æ –∑–∞–ø–∏—Å –¢–Ü–õ–¨–ö–ò –ø—ñ–¥ —á–∞—Å —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
  async function ensurePlayerRecord(name){
    if(!useFb) return;
    const ref = fs.doc(db,'players',playerId);
    const snap = await fs.getDoc(ref);
    if(!snap.exists()){
      await fs.setDoc(ref,{
        name,
        nameLower:name.toLowerCase(),
        status:2,
        bribes:Number(localStorage.getItem('bribes'))||0,
        updatedAt:Date.now()
      });
    }else{
      const d=snap.data()||{};
      await fs.setDoc(ref,{
        name,
        nameLower:name.toLowerCase(),
        bribes:d.bribes||0,
        updatedAt:Date.now()
      },{merge:true});
    }
  }

  function label(s){
    if(s===1) return '–í—ñ–¥—Å—Ç—Ä–æ—á–∫–∞üòé';
    if(s===3) return '–ú–æ–±—ñ–ª—ñ–∑–æ–≤–∞–Ω–∏–π üò©';
    return '–£—Ö–∏–ª—è–Ω—Çüòë';
  }

  async function loadBoard(){
    const body=$('boardBody'); body.innerHTML=`<tr><td colspan="3" class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</td></tr>`;
    let rows=[];
    if(useFb){
      const q=fs.query(fs.collection(db,'players'),fs.orderBy('bribes','desc'),fs.limit(1000));
      const snap=await fs.getDocs(q);
      snap.forEach(d=>{const v=d.data();rows.push({name:v.name,status:v.status,bribes:v.bribes||0});});
    }else{
      rows=[{name:playerName||'–ì—ñ—Å—Ç—å',status:Number(localStorage.getItem('status'))||2,bribes:Number(localStorage.getItem('bribes'))||0}];
    }
    rows.sort((a,b)=>(b.bribes||0)-(a.bribes||0));
    body.innerHTML=rows.map(r=>`<tr><td>${escapeHtml(r.name)}</td><td>${label(r.status)}</td><td>${r.bribes||0}</td></tr>`).join('');
  }

  function escapeHtml(s){
    return String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  boot();
  window.register=register;
</script>
</body>
</html>
