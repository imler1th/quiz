<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–í—Ö—ñ–¥ ‚Ä¢ –°—Ç–∞—Ç–∏ –Ω–∞ –æ–±–ª—ñ–∫</title>
<style>
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    margin: 0;
    background: url("vlk.1-1-1.jpg") no-repeat center center fixed;
    background-size: cover;
    color: #e2e8f0;
    overflow-x: hidden;
  }

  .wrap{max-width:900px;margin:40px auto;padding:0 16px}
  .card{
    background: rgba(17, 24, 39, 0.8);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 14px;
    padding: 20px;
    box-shadow: 0 8px 24px rgba(0,0,0,.3);
    margin-bottom: 16px;
  }
  h1{margin:0 0 10px}
  .muted{color:#94a3b8}
  .row{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0;align-items:center}
  input{padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e2e8f0;min-width:260px}
  button{padding:10px 14px;border-radius:10px;border:1px solid #334155;background:#1f2937;color:#e2e8f0;cursor:pointer}
  button:hover{background:#243041}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border-bottom:1px solid #243041;padding:10px 8px;text-align:left}
  th{color:#9fb2d1;font-weight:600}

  #preTestOverlay{position:fixed;inset:0;background:rgba(15,23,42,.96);display:none;justify-content:center;align-items:center;flex-direction:column;z-index:9999;text-align:center}
  #preTestOverlay.show{display:flex;animation:fadeIn .3s ease forwards}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  #preTestOverlay h2{font-size:2rem;margin-bottom:10px}
  #preTestOverlay p{color:#9fb2d1;font-size:1.1rem;margin-bottom:20px}
</style>
</head>
<body>
<div class="wrap">
  <!-- –°—Ç–∞—Ç–∏ –Ω–∞ –æ–±–ª—ñ–∫ -->
  <div class="card">
    <h1>–°—Ç–∞—Ç–∏ –Ω–∞ –æ–±–ª—ñ–∫</h1>
    <p class="muted" id="hello">–í–∫–∞–∂–∏ —ñ–º‚Äô—è, —â–æ–± —Å—Ç–∞—Ç–∏ –Ω–∞ –æ–±–ª—ñ–∫.</p>

    <div id="regBox" class="row">
      <input id="nameInput" type="text" maxlength="40" placeholder="–¢–≤–æ—î —ñ–º‚Äô—è">
      <button onclick="register()">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
    </div>

    <!-- –î—ñ—ó –ø—ñ—Å–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó -->
    <div id="actions" class="row"></div>

    <p class="muted" id="regHint"></p>
  </div>

  <!-- –û—Å–æ–±–æ–≤–∏–π —Å–∫–ª–∞–¥ -->
  <div class="card" style="margin-top:16px">
    <h1>–û—Å–æ–±–æ–≤–∏–π —Å–∫–ª–∞–¥</h1>
    <table>
      <thead><tr><th>–Ü–º‚Äô—è</th><th>–°—Ç–∞—Ç—É—Å</th><th>–•–∞–±–∞—Ä—ñ ($)</th></tr></thead>
      <tbody id="boardBody"><tr><td colspan="3" class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</td></tr></tbody>
    </table>
  </div>
</div>

<!-- –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–æ–º -->
<div id="preTestOverlay">
  <h2>üß† –£–≤–∞–≥–∞!</h2>
  <p>–£ —Ç–µ–±–µ —î –ª–∏—à–µ <strong>3 —Å–ø—Ä–æ–±–∏</strong> –ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç.</p>
  <p id="countdownText">–ü–µ—Ä–µ—Ö—ñ–¥ —á–µ—Ä–µ–∑ <span id="count">3</span> —Å‚Ä¶</p>
</div>

<script type="module">
/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 1) Firebase init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const firebaseConfig = {
  apiKey: "AIzaSyABgG9BNjzZP0LgMMOmirxUF_dccywAECI",
  authDomain: "test1-b220e.firebaseapp.com",
  projectId: "test1-b220e",
  storageBucket: "test1-b220e.firebasestorage.app",
  messagingSenderId: "913590893459",
  appId: "1:913590893459:web:04f04c5935eb24a3de0666",
  measurementId: "G-8PJR7M8F8Y"
};

const STATUS = { PASSED:1, DRAFT:2, FAILED:3 };
const $ = id => document.getElementById(id);
const safeHtml = (el, html) => { if (el) el.innerHTML = html; };

/* –ª–æ–∫–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω */
let useFb = !!firebaseConfig.apiKey;
let app, auth, db, fs;
let uid = null;

let playerId   = localStorage.getItem('playerId') || crypto.randomUUID();
let playerName = localStorage.getItem('playerName') || "";
localStorage.setItem('playerId', playerId);

function getStatus(){ return Number(localStorage.getItem('status')) || STATUS.DRAFT; }
function setStatus(s){ localStorage.setItem('status', String(s)); }
function getBribes(){ return Number(localStorage.getItem('bribes')) || 0; }
function setBribes(v){ localStorage.setItem('bribes', String(v)); }

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 2) Boot (login + Firestore) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function boot(){
  if(useFb){
    const appSdk = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js');
    const authSdk= await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js');
    const fsSdk  = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js');

    app  = appSdk.initializeApp(firebaseConfig);
    auth = authSdk.getAuth(app);
    fs   = fsSdk;

    try{
      await authSdk.signInAnonymously(auth);
      uid = auth.currentUser?.uid || null;
    }catch(e){
      // —è–∫—â–æ –∞–¥–±–ª–æ–∫ –±–ª–æ–∫—É—î firestore ‚Äî –±—É–¥–µ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º
      console.warn('Auth error (–º–æ–∂–µ –±—É—Ç–∏ AdBlock):', e);
      useFb = false;
    }

    if(useFb){
      db = fsSdk.initializeFirestore(app, {
        experimentalForceLongPolling:true,
        useFetchStreams:false,
        ignoreUndefinedProperties:true
      });
    }
  }

  if(playerName){
    $('hello') && ($('hello').textContent = '–í–∏ –≤–∂–µ —Å—Ç–æ—ó—Ç–µ –Ω–∞ –æ–±–ª—ñ–∫—É');
    $('regBox') && ( $('regBox').style.display = 'none' );
    await ensurePlayerRecord(playerName);
    await syncStatusFromDb();
    renderActions();
  }
  await loadBoard();
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 3) –î—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function register(){
  const name = $('nameInput')?.value.trim().slice(0,40) || "";
  if(!name){ $('regHint') && ( $('regHint').textContent='–í–≤–µ–¥–∏ —ñ–º‚Äô—è' ); return; }

  playerName = name;
  localStorage.setItem('playerName', name);
  $('hello') && ( $('hello').textContent = '–í–∏ –≤–∂–µ —Å—Ç–æ—ó—Ç–µ –Ω–∞ –æ–±–ª—ñ–∫—É' );
  $('regBox') && ( $('regBox').style.display = 'none' );

  await ensurePlayerRecord(name);
  await syncStatusFromDb();
  await loadBoard();
  renderActions();
  showPreTestOverlay();
}

function showPreTestOverlay(){
  const overlay = $('preTestOverlay');
  if(!overlay) return;
  overlay.classList.add('show');
  let sec = 3;
  const c = $('count');
  const t = setInterval(()=>{
    sec--; if(c) c.textContent = sec;
    if(sec<=0){ clearInterval(t); location.href='play.html'; }
  },1000);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 4) –†–æ–±–æ—Ç–∞ –∑ Firestore ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function ensurePlayerRecord(name){
  if(!useFb || !uid) return; // –æ—Ñ–ª–∞–π–Ω
  const ref  = fs.doc(db,'players',playerId);
  const snap = await fs.getDoc(ref);

  if(!snap.exists()){
    await fs.setDoc(ref,{
      ownerUid: uid,               // –í–ê–ñ–õ–ò–í–û –¥–ª—è –ø—Ä–∞–≤–∏–ª –±–µ–∑–ø–µ–∫–∏
      name,
      nameLower: name.toLowerCase(),
      status: STATUS.DRAFT,
      bribes: getBribes(),
      updatedAt: Date.now()
    });
  }else{
    // —Ç—Ä–∏–º–∞—î–º–æ ownerUid —ñ –æ–Ω–æ–≤–ª—é—î–º–æ –ª–∏—à–µ –ø–æ—Ç—Ä—ñ–±–Ω–µ
    await fs.setDoc(ref,{
      ownerUid: uid,
      name,
      nameLower: name.toLowerCase(),
      updatedAt: Date.now()
    },{ merge:true });
  }
}

async function syncStatusFromDb(){
  if(!useFb || !uid) return;
  try{
    const ref  = fs.doc(db,'players',playerId);
    const snap = await fs.getDoc(ref);
    if(snap.exists()){
      const s = Number(snap.data().status);
      if(s===STATUS.PASSED || s===STATUS.FAILED) setStatus(s);
    }
  }catch(e){ console.warn(e); }
}

async function retryWithBribe(){
  const next = getBribes() + 100;
  setBribes(next);
  setStatus(STATUS.DRAFT);

  if(useFb && uid){
    const ref = fs.doc(db,'players',playerId);
    await fs.setDoc(ref,{
      ownerUid: uid,
      bribes: next,
      status: STATUS.DRAFT,
      updatedAt: Date.now(),
      name: playerName
    },{ merge:true });
  }
  location.href = 'play.html';
}

async function loadBoard(){
  const body = $('boardBody');
  if(!body) return;                               // –∑–∞—Ö–∏—Å—Ç, —â–æ–± –Ω–µ –ø–∞–¥–∞–ª–æ
  safeHtml(body, `<tr><td colspan="3" class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</td></tr>`);

  let rows = [];
  if(useFb){
    try{
      const q = fs.query(
        fs.collection(db,'players'),
        fs.orderBy('bribes','desc'),
        fs.limit(1000)
      );
      const snap = await fs.getDocs(q);
      snap.forEach(d=>{
        const v=d.data();
        rows.push({ name:v.name, status:v.status, bribes:v.bribes||0 });
      });
    }catch(e){
      console.warn('Fetch board error (–º–æ–∂–µ –±—É—Ç–∏ AdBlock):', e);
    }
  }else{
    rows = [{ name: playerName||'–ì—ñ—Å—Ç—å', status: getStatus(), bribes: getBribes() }];
  }

  rows.sort((a,b)=>(b.bribes||0)-(a.bribes||0));
  const esc = s=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  safeHtml(body, rows.map(r=>`<tr><td>${esc(r.name)}</td><td>${label(r.status)}</td><td>${r.bribes||0}</td></tr>`).join(''));
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 5) UI –¥—Ä—ñ–±–Ω–∏—Ü—ñ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function label(s){
  if(s===STATUS.PASSED) return '–í—ñ–¥—Å—Ç—Ä–æ—á–∫–∞üòé';
  if(s===STATUS.FAILED) return '–ú–æ–±—ñ–ª—ñ–∑–æ–≤–∞–Ω–∏–π üò©';
  return '–£—Ö–∏–ª—è–Ω—Çüòë';
}

function renderActions(){
  const actions = $('actions'); if(!actions) return;
  actions.innerHTML = '';
  const status = getStatus();

  if(status === STATUS.DRAFT){
    const b = document.createElement('button');
    b.textContent = '–ü—Ä–æ–π—Ç–∏ –í–õ–ö ‚Üí';
    b.onclick = () => location.href='play.html';
    actions.appendChild(b);
  }
  if(status === STATUS.FAILED){
    const b = document.createElement('button');
    b.textContent = 'üí∏ 100$ –ø–æ–∂–µ—Ä—Ç–≤–∞ –¥–ª—è –¢–¶–ö ‚Äî ¬´–ü–æ—á–∞—Ç–∏ –∑–∞–Ω–æ–≤–æ¬ª';
    b.onclick = retryWithBribe;
    actions.appendChild(b);
  }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 6) –°—Ç–∞—Ä—Ç ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
window.addEventListener('DOMContentLoaded', boot);
window.register = register;   // —â–æ–± –ø—Ä–∞—Ü—é–≤–∞–ª–∞ –∫–Ω–æ–ø–∫–∞ ¬´–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏¬ª
</script>
</body>
</html>
