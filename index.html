<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyABgG9BNjzZP0LgMMOmirxUF_dccywAECI",
    authDomain: "test1-b220e.firebaseapp.com",
    projectId: "test1-b220e",
    storageBucket: "test1-b220e.firebasestorage.app",
    messagingSenderId: "913590893459",
    appId: "1:913590893459:web:04f04c5935eb24a3de0666",
    measurementId: "G-8PJR7M8F8Y"
  };

  const STATUS = {PASSED:1, DRAFT:2, FAILED:3};
  const $ = id => document.getElementById(id);

  let useFb = !!firebaseConfig.apiKey;
  let app,auth,db,fs;

  let playerId = localStorage.getItem('playerId') || crypto.randomUUID();
  localStorage.setItem('playerId', playerId);
  let playerName = localStorage.getItem('playerName') || "";

  // ‚úÖ —Ä–æ–±–∏–º–æ uid –¥–æ—Å—Ç—É–ø–Ω–∏–º —É –≤—Å—å–æ–º—É –º–æ–¥—É–ª—ñ
  let uid = null;

  async function boot(){
    if(useFb){
      const appSdk = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js');
      const authSdk = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js');
      const fsSdk   = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js');
      app = appSdk.initializeApp(firebaseConfig);
      auth = authSdk.getAuth(app);
      fs   = fsSdk;
      try{
        await authSdk.signInAnonymously(auth);
        uid = auth.currentUser?.uid || null;     // ‚úÖ –±–µ—Ä–µ–º–æ UID –ø—ñ—Å–ª—è –ª–æ–≥—ñ–Ω—É
      }catch(e){
        useFb=false;
      }
      db = fsSdk.initializeFirestore(app,{experimentalForceLongPolling:true,useFetchStreams:false,ignoreUndefinedProperties:true});
    }

    if(playerName && useFb){
      const ref  = fs.doc(db,'players',playerId);
      const snap = await fs.getDoc(ref);

      if(!snap.exists()){
        localStorage.clear();
        playerId = crypto.randomUUID();
        localStorage.setItem('playerId', playerId);
        $('regBox').style.display = 'flex';
      } else {
        $('hello').textContent = '–í–∏ –≤–∂–µ —Å—Ç–æ—ó—Ç–µ –Ω–∞ –æ–±–ª—ñ–∫—É';
        $('regBox').style.display = 'none';
        await syncStatusFromDb();
        renderActions();
      }
    }
    await loadBoard();
  }

  function showPreTestOverlay(){
    const overlay = $('preTestOverlay');
    overlay.classList.add('show');
    let sec = 3;
    const c = $('count');
    const t = setInterval(()=>{
      sec--; c.textContent = sec;
      if(sec<=0){ clearInterval(t); location.href='play.html'; }
    },1000);
  }

  async function register(){
    const name = $('nameInput').value.trim().slice(0,40);
    if(!name){ $('regHint').textContent='–í–≤–µ–¥–∏ —ñ–º‚Äô—è'; return; }

    playerName = name;
    localStorage.setItem('playerName', name);
    $('hello').textContent = '–í–∏ –≤–∂–µ —Å—Ç–æ—ó—Ç–µ –Ω–∞ –æ–±–ª—ñ–∫—É';
    $('regBox').style.display = 'none';

    await ensurePlayerRecord(name);
    await syncStatusFromDb();
    await loadBoard();
    renderActions();

    showPreTestOverlay();
  }

  async function syncStatusFromDb(){
    if(!useFb) return;
    try{
      const ref = fs.doc(db,'players',playerId);
      const snap = await fs.getDoc(ref);
      if(snap.exists()){
        const s = Number(snap.data().status);
        if(s===1||s===3) localStorage.setItem('status',String(s));
      }
    }catch(e){}
  }

  function renderActions(){
    const actions = $('actions');
    if(!actions) return;
    actions.innerHTML = '';
    const status = Number(localStorage.getItem('status')) || 2;

    if(status === STATUS.DRAFT){
      const btn = document.createElement('button');
      btn.textContent = '–ü—Ä–æ–π—Ç–∏ –í–õ–ö ‚Üí';
      btn.onclick = () => location.href='play.html';
      actions.appendChild(btn);
    }

    if(status === STATUS.FAILED){
      const btn = document.createElement('button');
      btn.textContent = 'üí∏ 100$ –ø–æ–∂–µ—Ä—Ç–≤–∞ –¥–ª—è –¢–¶–ö ‚Äî ¬´–ü–æ—á–∞—Ç–∏ –∑–∞–Ω–æ–≤–æ¬ª';
      btn.onclick = retryWithBribe;
      actions.appendChild(btn);
    }
  }

  // –î–∞—Ç–∏ —Ö–∞–±–∞—Ä + —Å–∫–∏–Ω—É—Ç–∏ —Å—Ç–∞—Ç—É—Å –Ω–∞ DRAFT(2) + –ø–µ—Ä–µ—Ö—ñ–¥ –¥–æ —Ç–µ—Å—Ç—É
  async function retryWithBribe(){
    const cur = Number(localStorage.getItem('bribes'))||0;
    const next = cur + 100;
    localStorage.setItem('bribes', String(next));
    localStorage.setItem('status', String(STATUS.DRAFT));

    if(useFb){
      const ref = fs.doc(db,'players',playerId);
      await fs.setDoc(ref,{
        ownerUid: uid,                // ‚úÖ –¥–æ–¥–∞—î–º–æ –≤–ª–∞—Å–Ω–∏–∫–∞
        bribes: next,
        status: STATUS.DRAFT,
        updatedAt: Date.now(),
        name: playerName
      },{merge:true});
    }
    location.href = 'play.html';
  }

  // —Å—Ç–≤–æ—Ä—é—î–º–æ/–æ–Ω–æ–≤–ª—é—î–º–æ –∑–∞–ø–∏—Å –ø—ñ–¥ —á–∞—Å —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
  async function ensurePlayerRecord(name){
    if(!useFb) return;
    const ref = fs.doc(db,'players',playerId);
    const snap = await fs.getDoc(ref);
    if(!snap.exists()){
      await fs.setDoc(ref,{
        ownerUid: uid,                // ‚úÖ –¥–æ–¥–∞—î–º–æ –≤–ª–∞—Å–Ω–∏–∫–∞
        name,
        nameLower:name.toLowerCase(),
        status:2,
        bribes:Number(localStorage.getItem('bribes'))||0,
        updatedAt:Date.now()
      });
    }else{
      const d=snap.data()||{};
      await fs.setDoc(ref,{
        ownerUid: uid,                // ‚úÖ —Ç—Ä–∏–º–∞—î–º–æ –≤–ª–∞—Å–Ω–∏–∫–∞ —ñ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è—Ö
        name,
        nameLower:name.toLowerCase(),
        bribes:d.bribes||0,
        updatedAt:Date.now()
      },{merge:true});
    }
  }

  function label(s){
    if(s===1) return '–í—ñ–¥—Å—Ç—Ä–æ—á–∫–∞üòé';
    if(s===3) return '–ú–æ–±—ñ–ª—ñ–∑–æ–≤–∞–Ω–∏–π üò©';
    return '–£—Ö–∏–ª—è–Ω—Çüòë';
  }

  async function loadBoard(){
    const body=$('boardBody'); body.innerHTML=`<tr><td colspan="3" class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</td></tr>`;
    let rows=[];
    if(useFb){
      const q=fs.query(fs.collection(db,'players'),fs.orderBy('bribes','desc'),fs.limit(1000));
      const snap=await fs.getDocs(q);
      snap.forEach(d=>{const v=d.data();rows.push({name:v.name,status:v.status,bribes:v.bribes||0});});
    }else{
      rows=[{name:playerName||'–ì—ñ—Å—Ç—å',status:Number(localStorage.getItem('status'))||2,bribes:Number(localStorage.getItem('bribes'))||0}];
    }
    rows.sort((a,b)=>(b.bribes||0)-(a.bribes||0));
    body.innerHTML=rows.map(r=>`<tr><td>${escapeHtml(r.name)}</td><td>${label(r.status)}</td><td>${r.bribes||0}</td></tr>`).join('');
  }

  function escapeHtml(s){
    return String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  boot();
  window.register=register;
</script>
